# Caching policy
<IfModule headers_module>
  <FilesMatch "\.(png|jpe?g|gif|svg|svg\.gz|svg\.br|webm|mp4|webp|woff2?|ico|css|css\.gz|css\.br|m?js|m?js\.gz|m?js\.br)$">
    FileETag None
    Header unset ETag
    Header set Cache-Control "public, max-age=31536000"
  </FilesMatch>
  <FilesMatch "\.(html|php|xml|xml\.gz|xml\.br|txt|svg|svg\.gz|svg\.br|css|css\.gz|css\.br|m?js|m?js\.gz|m?js\.br)$">
    Header set Vary "Accept-Encoding"
  </FilesMatch>
  <FilesMatch "\.(html|html\.br|html\.gz|txt|xml|xml\.gz|xml\.br)$">
    FileETag None
    Header unset ETag
    Header set Cache-Control "private, max-age=600"
    Header set Vary "Accept-Encoding, Save-Data"
  </FilesMatch>
</IfModule>

<IfModule mime_module>
  AddType text/javascript .mjs
</IfModule>

# Set HSTS
Header set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" env=HTTPS

# Static compression!
<Files *.js.br>
    AddType "text/javascript" .br
    AddEncoding br .br
</Files>
<Files *.mjs.br>
    AddType "text/javascript" .br
    AddEncoding br .br
</Files>
<Files *.css.br>
    AddType "text/css" .br
    AddEncoding br .br
</Files>
<Files *.svg.br>
    AddType "image/svg+xml" .br
    AddEncoding br .br
</Files>
<Files *.html.br>
    AddType "text/html" .br
    AddEncoding br .br
</Files>
<Files *.js.gz>
    AddType "text/javascript" .gz
    AddEncoding gzip .gz
</Files>
<Files *.mjs.gz>
    AddType "text/javascript" .gz
    AddEncoding gzip .gz
</Files>
<Files *.css.gz>
    AddType "text/css" .gz
    AddEncoding gzip .gz
</Files>
<Files *.svg.gz>
    AddType "image/svg+xml" .gz
    AddEncoding gzip .gz
</Files>
<Files *.html.gz>
    AddType "text/html" .gz
    AddEncoding gzip .gz
</Files>

# Allow URL rewriting
RewriteEngine On

# Rewrites for the Save-Data header
RewriteCond %{HTTP:Save-Data} =on [NC]
RewriteCond %{REQUEST_URI} !savedata.html$
RewriteRule ^(.*).html$ $1.savedata.html [L]

RewriteCond %{HTTP:Save-Data} !=on [NC]
RewriteCond %{REQUEST_URI} savedata.html$
RewriteRule ^(.*).savedata.html$ $1.html [L,R=302]

# Serve pre-compressed Brotli assets
RewriteCond %{HTTP:Accept-Encoding} br
RewriteCond %{REQUEST_FILENAME}.br -f
RewriteRule ^(.*)$ $1.br [L]

# Serve pre-compressed gzip assets
RewriteCond %{HTTP:Accept-Encoding} gzip
RewriteCond %{REQUEST_FILENAME}.gz -f
RewriteRule ^(.*)$ $1.gz [L]
